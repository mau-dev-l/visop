<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>VISOP 2.0 - Visor de Obra Pública</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/map-controls.css">
    <link rel="stylesheet" href="css/popups.css">
    <link rel="stylesheet" href="css/dashboards.css">

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist-min@2.32.0/plotly.min.js"></script>
</head>
<body style="padding: 0; margin: 0;" >

    <div id="loader-wrapper"></div>

    <div id="app-container" class="geoportal-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        /**
         * Carga fragmentos HTML desde la carpeta 'components' e inyecta en el contenedor indicado
         */
        async function loadComponent(file, container, position = 'beforeend') {
            try {
                // Se agrega el prefijo 'components/' basándonos en tu estructura de directorio
                const response = await fetch(`components/${file}`); 
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status} en ${file}`);
                const html = await response.text();
                
                const target = (typeof container === 'string') ? document.querySelector(container) : container;
                if (target) {
                    target.insertAdjacentHTML(position, html);
                }
            } catch (err) {
                console.error(`Error cargando componente [${file}]:`, err);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const container = document.getElementById('app-container');
            const loaderWrapper = document.getElementById('loader-wrapper');

            // 1. Cargar el loader (Overlay de espera)
            await loadComponent('loader.html', loaderWrapper);
            
            // 2. Cargar la estructura base de la interfaz
            await loadComponent('header.html', container);
            await loadComponent('sidebar.html', container);
            await loadComponent('main_content.html', container); // Este genera el div 'map-container'
            await loadComponent('footer.html', container);
            
            // 3. Cargar componentes flotantes (Modales y Manuales)
            await loadComponent('modals.html', document.body);
            await loadComponent('manual.html', document.body);
            await loadComponent('login.html', document.body); 

            try {
                // 4. Importar e iniciar la lógica de la aplicación (Leaflet, Capas, Dashboards)
                const { iniciarVisop } = await import('./js/app.js');
                await iniciarVisop(); 

                // 5. Finalizar y remover el loader si todo cargó correctamente
                const overlay = document.getElementById('loading-overlay');
                if (overlay) {
                    overlay.style.opacity = '0';
                    overlay.style.visibility = 'hidden';
                    setTimeout(() => overlay.remove(), 500);
                }
            } catch (err) {
                console.error("Error crítico en el arranque de VISOP:", err);
                const overlay = document.getElementById('loading-overlay');
                if (overlay) overlay.remove();
            }
        });
    </script>
</body>
</html>