<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>VISOP 2.0 - Visor de Obra Pública</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <link rel="stylesheet" href="css/style.css">

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist-min@2.32.0/plotly.min.js"></script>
</head>
<body>

    <div id="loader-wrapper"></div>

    <div id="app-container" class="geoportal-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        async function loadComponent(file, container, position = 'beforeend') {
            try {
                const response = await fetch(`components/${file}`);
                if (!response.ok) throw new Error(`No se pudo cargar ${file}`);
                const html = await response.text();
                container.insertAdjacentHTML(position, html);
            } catch (err) {
                console.error(`Error cargando componente [${file}]:`, err);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const container = document.getElementById('app-container');
            const loaderWrapper = document.getElementById('loader-wrapper');

            // 1. Mostrar Spinner inmediatamente
            await loadComponent('loader.html', loaderWrapper);
            
            // 2. Cargar estructura de la interfaz
            await loadComponent('header.html', container);
            await loadComponent('sidebar.html', container);
            await loadComponent('main_content.html', container);
            await loadComponent('footer.html', container);
            
            // 3. Cargar componentes de apoyo y seguridad
            await loadComponent('modals.html', document.body);
            await loadComponent('manual.html', document.body);
            await loadComponent('login.html', document.body); // Inyección del modal de acceso

            try {
                // 4. Iniciar lógica de la aplicación
                const { iniciarVisop } = await import('./js/app.js');
                await iniciarVisop(); 

                // 5. Ocultar el Spinner
                const overlay = document.getElementById('loading-overlay');
                if (overlay) {
                    overlay.style.opacity = '0';
                    overlay.style.visibility = 'hidden';
                    setTimeout(() => overlay.remove(), 500);
                }
            } catch (err) {
                console.error("Error crítico en el arranque:", err);
                const overlay = document.getElementById('loading-overlay');
                if (overlay) overlay.remove();
            }
        });
    </script>
</body>
</html>